<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Генератор курсов - CourseGen</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#a3ff00",
                        "cobblestone-blue": "#2C3E50",
                        "icy-blue": "#AED9E0",
                        "graphite-gray": "#7F8C8D",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"},
                },
            },
        }
    </script>
</head>
<body class="bg-white font-display text-cobblestone-blue">
    <div class="flex h-auto min-h-screen w-full flex-col">
        <!-- TopNavBar -->
        <header class="sticky top-0 z-10 w-full border-b border-graphite-gray/20 bg-white/80 backdrop-blur-md">
            <div class="relative mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <!-- Логотип слева -->
                    <div class="flex items-center gap-4">
                        <h2 class="text-xl font-bold leading-tight tracking-tight text-cobblestone-blue">CourseGen</h2>
                    </div>

                    <!-- Навигация по центру (абсолютное позиционирование) -->
                    <nav class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-8">
                        <a class="text-sm font-medium text-cobblestone-blue transition-colors hover:text-primary hidden md:block" href="/">Главная</a>
                        <a class="text-sm font-medium text-cobblestone-blue transition-colors hover:text-primary hidden md:block" href="/my-courses">Мои курсы</a>
                        <a class="text-sm font-medium text-cobblestone-blue transition-colors hover:text-primary hidden md:block" href="/generator">Генератор</a>
                        <a class="text-sm font-medium text-cobblestone-blue transition-colors hover:text-primary hidden md:block" href="/support">Поддержка</a>
                    </nav>

                    <!-- Кнопки справа -->
                    <div id="auth-buttons" class="flex items-center gap-2">
                        <a href="/register" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-4 text-sm font-bold leading-normal tracking-wide text-cobblestone-blue transition-transform hover:scale-105">
                            <span class="truncate">Регистрация</span>    
                        </a>
                        <a href="/login" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-100 px-4 text-sm font-bold leading-normal tracking-wide text-cobblestone-blue transition-transform hover:scale-105">
                            <span class="truncate">Вход</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="mx-auto w-full max-w-4xl flex-1 px-4 py-8 sm:px-6 lg:px-8 lg:py-12">
            <div class="layout-content-container flex flex-col">
                <!-- PageHeading -->
                <div class="mb-12 text-center">
                    <h1 class="mb-4 text-3xl font-bold leading-tight tracking-tight text-cobblestone-blue sm:text-4xl">
                        Создайте новый курс
                    </h1>
                    <p class="text-lg text-graphite-gray">Добавьте ссылку на YouTube-видео или загрузите PDF-файл, и мы создадим полноценный учебный курс на их основе</p>
                </div>

                <!-- Единая форма со значками -->
                <div class="mb-12" id="generator-form">
                <label class="flex flex-col">
                    <div class="mb-4 flex w-full items-stretch rounded-xl shadow-sm">
                        <!-- Значок ссылки -->
                        <div class="flex items-center justify-center rounded-l-xl border border-r-0 border-graphite-gray/20 bg-gray-50 px-4">
                            <span class="material-symbols-outlined text-graphite-gray">link</span>
                        </div>
                        <!-- Значок PDF (при клике открывается обзор файлов) -->
                        <div class="flex items-center justify-center border border-r-0 border-gray-200 bg-gray-50 px-3 cursor-pointer hover:bg-icy-blue transition"
                             id="pdf-upload-icon"
                             title="Выберите PDF для курса">
                            <span class="material-symbols-outlined text-cobblestone-blue">picture_as_pdf</span>
                            <input type="file" accept="application/pdf" id="pdf-upload-input" class="hidden" />
                        </div>
                        <!-- поле ввода для ссылки -->
                        <input class="flex w-full min-w-0 flex-1 resize-none overflow-hidden border border-graphite-gray/20 bg-white px-4 text-base font-normal leading-normal text-cobblestone-blue placeholder:text-graphite-gray focus:outline-none focus:ring-2 focus:ring-primary/50" 
                            placeholder="Вставьте ссылку на YouTube видео..." 
                            value=""
                            id="video-url-input"/>
                        <div class="flex items-center justify-center rounded-r-xl border border-l-0 border-graphite-gray/20 bg-gray-50 p-1.5">
                            <button id="create-course" class="flex h-full min-w-[120px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-primary px-6 text-base font-bold leading-normal tracking-wide text-cobblestone-blue transition-transform hover:scale-105">
                                <span id="create-course-text" class="truncate">Создать курс</span>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-graphite-gray text-center">Поддерживаются: youtube.com, youtu.be и PDF-формат</p>
                </label>
            </div>

                <!-- Result Container -->
                <div id="result-container" class="mb-8 hidden">
                    <div class="rounded-xl border border-primary/20 bg-primary/5 p-6">
                        <h3 class="mb-4 text-xl font-bold text-cobblestone-blue">Сгенерированный курс</h3>
                        <div id="generator-result" class="max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="mb-16">
                    <h2 class="mb-8 text-center text-2xl font-bold text-cobblestone-blue">Что будет в вашем курсе</h2>
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                        <div class="flex flex-col items-center rounded-xl border border-graphite-gray/20 bg-white p-6 text-center">
                            <div class="mb-4 text-primary">
                                <span class="material-symbols-outlined text-4xl">description</span>
                            </div>
                            <h3 class="mb-2 text-lg font-bold text-cobblestone-blue">Структурированный конспект</h3>
                            <p class="text-sm text-graphite-gray">Ключевые моменты из видео или документа в удобном формате</p>
                        </div>
                        <div class="flex flex-col items-center rounded-xl border border-graphite-gray/20 bg-white p-6 text-center">
                            <div class="mb-4 text-primary">
                                <span class="material-symbols-outlined text-4xl">quiz</span>
                            </div>
                            <h3 class="mb-2 text-lg font-bold text-cobblestone-blue">Интерактивные тесты</h3>
                            <p class="text-sm text-graphite-gray">Проверка знаний и закрепление материала</p>
                        </div>
                        <div class="flex flex-col items-center rounded-xl border border-graphite-gray/20 bg-white p-6 text-center">
                            <div class="mb-4 text-primary">
                                <span class="material-symbols-outlined text-4xl">picture_as_pdf</span>
                            </div>
                            <h3 class="mb-2 text-lg font-bold text-cobblestone-blue">PDF документ</h3>
                            <p class="text-sm text-graphite-gray">Скачайте готовый курс, включая конспект и тесты, для офлайн-изучения</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/generate.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // обработчик для основной кнопки
            const createButton = document.getElementById('create-course');
            if (createButton) {
                createButton.addEventListener('click', handleCourseCreation);
            }
            // обработчик для pdf-иконки
            document.getElementById('pdf-upload-icon').addEventListener('click', function () {
                document.getElementById('pdf-upload-input').click();
            });
            document.getElementById('pdf-upload-input').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                handleCourseCreationFromPDF(file);
            });

            // Проверка авторизации
            const token = localStorage.getItem('access_token');
            const userEmail = localStorage.getItem('user_email');
            const navButtons = document.querySelector('.flex.items-center.gap-2');
            if (token && userEmail && navButtons) {
                navButtons.innerHTML = `
                    <span class="text-sm text-graphite-gray">${userEmail}</span>
                    <button onclick="logout()" class="flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-100 px-4 text-sm font-bold leading-normal tracking-wide text-cobblestone-blue transition-transform hover:scale-105">
                        <span class="truncate">Выйти</span>
                    </button>
                `;
            }
            const videoInput = document.getElementById('video-url-input');
            if (videoInput) {
                videoInput.focus();
            }
        });

        // Функция для создания курса из PDF
        window.handleCourseCreationFromPDF = function(file) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Пожалуйста, войдите в систему для создания курсов');
                setTimeout(() => { window.location.href = '/login'; }, 2000);
                return;
            }
            const formData = new FormData();
            formData.append('pdf', file);
            fetch('/api/generate-course-from-pdf', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        alert(`✅ Курс "${data.title}" успешно создан! Перенаправление...`);
                        setTimeout(() => {
                            window.location.href = '/my-courses';
                        }, 2000);
                    } else {
                        alert('❌ Ошибка при создании курса из PDF: ' + (data.detail || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Network error:', error);
                    alert('❌ Ошибка сети при создании курса');
                });
        };
    </script>
</body>
</html>
